From be5fc011f4eda9ff6391ecef1da2f278e7eeee7d Mon Sep 17 00:00:00 2001
From: William Yardley <wby@axs.com>
Date: Thu, 7 Sep 2017 23:05:11 -0700
Subject: [PATCH] Fix for #618, adds config_ranch parameter (default: true) to
 suppress certain config lines

---
 README.md                     | 5 +++++
 manifests/config.pp           | 7 -------
 manifests/init.pp             | 1 +
 manifests/params.pp           | 1 +
 templates/rabbitmq.config.erb | 2 +-
 5 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/README.md b/README.md
index cec5076..4f0ebfd 100644
--- a/README.md
+++ b/README.md
@@ -227,6 +227,11 @@ The path to write the RabbitMQ configuration file to.
 
 Hash of configuration variables for the [Management Plugin](https://www.rabbitmq.com/management.html).
 
+#### `config_ranch`
+
+Boolean. When true, suppresses sections of the config that existed before the
+ranch switch. May need to be disabled for RabbitMQ < 3.6. Default True.
+
 #### `config_stomp`
 
 Boolean to enable or disable stomp.
diff --git a/manifests/config.pp b/manifests/config.pp
index 72a5cb3..1095c27 100644
--- a/manifests/config.pp
+++ b/manifests/config.pp
@@ -129,13 +129,6 @@ class rabbitmq::config {
     $environment_variables = $_environment_variables
   }
 
-  # Get ranch (socket acceptor pool) availability,
-  # Now that we have to rely on the fact, this may cause some chicken / egg
-  # or idempotency problems
-  if $facts['rabbitmq_version'] {
-    $ranch = versioncmp($facts['rabbitmq_version'], '3.6') >= 0
-  }
-
   file { '/etc/rabbitmq':
     ensure => directory,
     owner  => '0',
diff --git a/manifests/init.pp b/manifests/init.pp
index 27335f0..bb1b574 100644
--- a/manifests/init.pp
+++ b/manifests/init.pp
@@ -16,6 +16,7 @@ class rabbitmq(
   String $config                                 = $rabbitmq::params::config,
   Boolean $config_cluster                        = $rabbitmq::params::config_cluster,
   Stdlib::Absolutepath $config_path              = $rabbitmq::params::config_path,
+  Boolean $config_ranch                          = $rabbitmq::params::config_ranch,
   Boolean $config_stomp                          = $rabbitmq::params::config_stomp,
   Boolean $config_shovel                         = $rabbitmq::params::config_shovel,
   Hash $config_shovel_statics                    = $rabbitmq::params::config_shovel_statics,
diff --git a/manifests/params.pp b/manifests/params.pp
index 189993b..e8c8915 100644
--- a/manifests/params.pp
+++ b/manifests/params.pp
@@ -73,6 +73,7 @@ class rabbitmq::params {
   $config                      = 'rabbitmq/rabbitmq.config.erb'
   $config_cluster              = false
   $config_path                 = '/etc/rabbitmq/rabbitmq.config'
+  $config_ranch                = true
   $config_stomp                = false
   $config_shovel               = false
   $config_shovel_statics       = {}
diff --git a/templates/rabbitmq.config.erb b/templates/rabbitmq.config.erb
index 48019dc..c92e64b 100644
--- a/templates/rabbitmq.config.erb
+++ b/templates/rabbitmq.config.erb
@@ -18,7 +18,7 @@
     {cluster_partition_handling, <%= @cluster_partition_handling %>},
 <% end -%>
     {tcp_listen_options, [
-         <%- unless @ranch -%>
+         <%- unless @config_ranch -%>
          binary,
          {packet,        raw},
          {reuseaddr,     true},
-- 
2.9.5

